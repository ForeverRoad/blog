---
title: Mysql
date: 2022-02-17 16:06:09
tags: 数据库
categories: 数据库
---


#### 逻辑架构

1. 连接和线程处理，进行连接，安全，权限验证
2. 查询，缓存，解析器，优化器等
3. 存储引擎，负责存储和获取数据




#### 锁

1. 表锁
2. 行锁，最大程度支持并发，在存储引擎层实现
3. 读锁（共享锁），写锁（排它锁）


#### 事务

> 要么全部执行，要么全不执行，保证一段SQL是原子性的执行

事务包含ACID四个特性

1. 原子性A
	- 最小不可分割单元，执行结果是一致的 	
2. 一致性C
	
3. 隔离性I
	- 在事务执行结束前，对其他事务是不可见的
4. 持久性D
	- 一但事务提交，就会持久化存储



#### 索引

> 利用B-Tree进行顺序索引，加快访问速度。可以单列或多列索引。

索引特点：
	1. 全值匹配：单列或多列索引全量匹配
	2. 匹配最左前缀: 对于符合索引，也可只用最左前缀的列，索引依然生效，如果查询顺序与索引列顺序不一致，索引就不生效。
	3. 匹配列前缀： 也可以匹配值的开头部分，如 like '张%'。
	4. 只访问索引的查询： 查询只访问索引，不查询数据行。

聚簇索引： 一种数据存储方式，数据行和相邻的键值连续的存储在一起，所以一个表只能有一个聚簇索引（主键，如果缺失会选一个唯一索引，如果没有索引，就会默认一个）

优点：
	1. 分页，可以连续取出多个行数据，减少磁盘IO
	2. 访问更快，讲索引与数据存储在一起
	3. 使用覆盖索引查询时可以直接获取到主键
缺点：
	1. 因为连续性，所以必须顺序插入，否则会造成表的重新整理和页分裂
	2. 更新聚簇索引的代价高，必须重排或移动
	3. 二级索引需要两次查询才能获取到数据，先获取到聚簇索引再根据主键查询数据

覆盖索引：
	如果查询字段命中索引，就会只查二级索引获取值返回，而不用再次根据聚簇索引去查数据行。排序也适用


#### 查询状态

1. sleep: 睡眠，线程等待客户端发送新的请求
2. query: 正在进行执行查询或者正在为客户端发送数据
3. locked: 对应服务层，该线程正在等待表锁，存储引擎实现的锁不会表现在该状态下。
4. analyzing and statistics: 线程正在收集存储引擎的统计信息，并生成查询的执行计划。
5. copying to tmp table[on disk]: 正在复制到临时表中，常发生在group by,文件排序操作，或者union，当出现on disk表示正在把临时表存放到磁盘
6. sorting result: 正在对结果排序



#### 查询执行过程

1. 客户端发送查询请求
2. 查询是否命中缓存
3. 解析器解析SQL语句，检查语法错误等
4. 预处理器，进一步检查表，列等是否存在，验证权限
5. 查询优化器，把查询转换成执行计划，并尝试找到最优的执行计划
6. 查询执行引擎
7. 返回结果给客户端


#### 在同一个表上查询并更新

> Mysql 不允许同一张表同时查询并更新

``` SQL
	UPDATE tbl AS outer_tbl
	SET cnt = (
		SELECT
			count(1)
		FROM
			tbl AS inner_tbl
		WHERE
			inner_tbl.type = outer_tbl.type
	);

	-- 上面的sql会执行失败

	-- 林勇临时表绕过限制，子查询select形成临时表，然后关联update

	UPDATE tbl AS outer_tbl
	INNER JOIN (
		SELECT
			count(1) AS cnt,
			type
		FROM
			tbl AS inner_tbl
	) AS der USING (type)
	SET outer_tbl.cnt = der.cnt;

```